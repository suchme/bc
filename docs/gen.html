<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="ja" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<title>datagen</title>
</head>

<body>
<div>ちょっとまって</div>
</body>

<script type="text/javascript">
"use strict";
var DATA={shinkis:[],armors:[],individuals:[]};
//データ整形ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー

var mem=[ "cd","set","class","name","rarelity"
	,"atk","def","spd","lp","bst"
	,"recover","dash"
	,"dash_cost","jump_cost","hover_cost","guard_cost"
	,"passive","effect","active","active_effect"
	,"biko"];
var conv=function(row,n){
	var armor = {};


	armor.part=n;

	mem.forEach(function(e,index){
		armor[e]=row[index];
	});
	if(armor.biko==="-")armor.biko="";
	return armor;
}

var prepareData=function(data){
	//省略セルデータ補間
	var keys = Object.keys(data);
	for(var i=0;i < keys.length;i++){
		if(keys[i]==="lists"){ continue; }
		var list = data[keys[i]];
		for(var j=1;j<list.length;j++){
			var row = list[j];
			for(var k=0;k<row.length;k++){
				if(row[k]==="" || row[k]==="#N/A"){
					row[k]=list[j-1][k];
				}
			}
		}
		
	}
	//名称リスト
	var lists = data.lists;
	for(var i=0;i<lists[0].length;i++){
		var list=[];
		for(var j=1;j<lists.length;j++){
			if(lists[j][i] ==="")break;
			list.push(lists[j][i]);
		}
		DATA[lists[0][i]]=list;
	}

	//神姫
	var mem=[
		"cd","name","atk","def","spd","lp","bst"
		,"recover","dash"
		,"dash_cost","jump_cost","hover_cost","guard_cost"
		,"exskill","biko"];
	for(var i=0;i<data.shinki.length;i++){
		var row = data.shinki[i];
		var shinki= {};

		mem.forEach(function(e,index){
			shinki[e]=row[index];

		});
		var idx = mem.length;
		shinki.apts=row.slice(idx,idx+15);
		shinki.apts.unshift(0);
		shinki.rarelity=0;

		if(shinki.biko==="-"){
			shinki.biko="";
		}
		DATA.shinkis.push(shinki);
	}

	//アイコン補正
	for(var i=0;i<data.individuals.length;i++){
		var row = data.individuals[i];
		var individual= {};
		individual.name=row[0];
		individual.atk=Number(row[1]);
		individual.def=Number(row[2]);
		individual.spd=Number(row[3]);
		individual.lp=Number(row[4]);
		individual.bst=Number(row[5]);
		individual.dash=0;
		individual.recover=0;
		individual.dash_cost=0;
		individual.jump_cost=0;
		individual.guard_cost=0;
		individual.hover_cost=0;
		DATA.individuals.push(individual);
	}

	//パッシブ
	DATA.passives= data.passive.map(function(e){return {name:e[0],effect_type:e[1],biko:e[2]};});


	//アクティブ
	DATA.actives = data.active.map(function(e){return {name:e[0],effect_type:e[1],biko:e[2]};});

	//武装
	for(var j=1;j<6;j++){
		var part=DATA.part_cd[j];
		var part_data= data[part];
		if(!part_data)continue;
		for(var i=0;i<part_data.length;i++){
			var row = part_data[i];
			var armor = conv(row,j);
			DATA.armors.push(armor);

	  		if(j===5){
	  			armor.flying=row[21];
				if(armor.flying !== 1)armor.flying=0;
			}
		}
	}

	//武器
	var part_data= data.weapon;
	var mems=part_data[0];
	part_data.forEach((row,idx)=>{
		if(!idx)return;
		var armor={part:6};
		row.forEach((col,idx)=>{
			armor[mems[idx]] = col;
		});
		if(armor.biko==="-"){
			armor.biko="";
		}
		DATA.armors.push(armor);

	});
//	for(var i=0;i<part_data.length;i++){
//		var row = part_data[i];
//		var armor = conv(row,6);
//		armor.passive=0;
//		armor.active=row[16];
//		armor.active_effect=row[17];
//		armor.biko=row[18];
//		if(armor.biko==="-"){
//			armor.biko="";
//		}
//		armor.category=row[19];
//		armor.range=row[20];
//		DATA.armors.push(armor);
//	}


	DATA.armors.forEach(function(e){
		if(DATA.actives[e.active].effect_type===1 && e.active_effect===0){
			e.active_effect=e.rarelity+1;
		}
	});

	DATA.armors.forEach(function(e){
		if(e.set ===""){ e.set="-"}
		if(e.set.indexOf("M")===0){
			e.set = e.set.substr(1);
			e.parent="-";
		}else{
			e.parent=e.set;
			e.set="";
		}

	});

	//レベル増加値
	DATA.lv_bonus={};
	var sheet_data = data.lv_bonus;
	var mems=sheet_data[0];
	for(var i=1;i < sheet_data.length;){
		var bonuses=[];
		var row = sheet_data[i];
		var part = row[0];
		for(var j=0;j < 4;j++){
			var bonus={};
			var row = sheet_data[i];
			row.forEach((a,idx)=>{
				if(!idx)return;
				bonus[mems[idx]]=a;
			});
			bonuses.push(bonus);
			i++;
		}
		DATA.lv_bonus[part] = bonuses;
	}

	;
	DATA.shinki_default_status={};
	DATA.shinki_rarelity_bonus=[{},{},{},{}];
	DATA.param_cd.forEach(function(e,idx){
		DATA.shinki_default_status[e] = Number(data.rarelity_bonus[0][idx]);
		DATA.shinki_rarelity_bonus[0][e] = 0;
		DATA.shinki_rarelity_bonus[1][e] = Number(data.rarelity_bonus[1][idx]);
		for(var i=0;i<2;i++){
			DATA.shinki_rarelity_bonus[i+2][e] = DATA.shinki_rarelity_bonus[1][e]*(i+2);
		}
	});


	DATA.date= Date.now();


    let blob = new Blob(["const DATA=",JSON.stringify(DATA),";export default DATA;"],{type:"text/plan"});
	var a =document.createElement('a');
	a.href=URL.createObjectURL(blob);
	a.innerText="data.js";
	a.download="data.js";
	document.body.appendChild(a);
	var span =document.querySelector('div');
	span.textContent="できた";
	document.body.appendChild(span);
}
</script>
<script type="text/javascript" src="https://script.google.com/macros/s/AKfycbzZ0Kh-rmnkj5bzF5HZwb_QVxHiiQUhAYcOl7SrzCo/dev"></script>
</html>


